# TODO Настроил проксирование, но не сделал кеширование

# docker build . -t cdn-node
# docker run -v /Users/des/cdn:/var/cdn/ -e "CDN_NODE=1" cdn-node
# docker build . -t cdn-node; docker run -v /Users/des/cdn:/var/cdn/ -e "CDN_NODE=1" cdn-node


user                root;
worker_processes    5;
error_log           /var/log/nginx/errors.log;

worker_rlimit_nofile 8192;

events {
  worker_connections  4096;  ## Default: 1024
}


http {
    include             /etc/nginx/mime.types;


    default_type        application/octet-stream;
    access_log          /var/log/nginx/access.log;
    charset             utf-8;

    server {
        listen 8000;
        server_name sw-cdn-${CDN_NODE}.somn.ru;

        location / {
            root /var/cdn/files;
            try_files $uri $uri/ @master_node;
        }

        location @master_node {
            proxy_pass http://sw-cdn-master.somn.ru;

            #proxy_set_header X-Real-IP $remote_addr;
            #proxy_set_header Host $host;
            #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        }
    }


    # TODO MASTER SIMULATED
    server {
        server_name sw-cdn-master.somn.ru;
        listen 8001;
        location / {
            return 200 'gangnam style!';
            # root /var/cdn/files-master;
        }
    }
}

#wget localhost:8000/lolkek.png